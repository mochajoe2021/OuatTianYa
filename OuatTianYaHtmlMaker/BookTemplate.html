<!DOCTYPE HTML>
<html>

<head>
	<meta charset="utf-8" />
	<script src=" https://cdn.jsdelivr.net/npm/crypto-js@4.0.0/crypto-js.js">
	</script>

	<script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.0.0-rc.1/bin/jsencrypt.js">
		//https://cdn.jsdelivr.net/npm/jsencrypt@3.0.0-rc.1/bin/jsencrypt.js
		//https://cdn.jsdelivr.net/npm/jsencrypt@3.1.0/bin/jsencrypt.js
	</script>
	<script type="text/javascript">
		var mochajoebook = "";
		var ChapterCount = 0;
		var privkey = "";
		var signkey = "";
		var keyok = false;
	</script>

	<script type="text/javascript">
		function pubprikey() {
			signkey = document.getElementById("signpubkey");
			privkey = document.getElementById("privkey");
			show = document.getElementById("show");
			if (signpubkey.value.length < 100 || privkey.value.length < 100) {
				signpubkey.style.visibility = "visible";
				privkey.style.visibility = "visible";
				show.style.visibility = "hidden";

			} else {
				signpubkey.style.visibility = "hidden";
				privkey.style.visibility = "hidden";
				signpubkey.style.height = 0;
				privkey.style.height = 0;
				show.style.visibility = "visible";

				signpubkey = document.getElementById("signpubkey");
				privkey = document.getElementById("privkey");
				show = document.getElementById("show");
				keyok = true;


			}
		}
		function getChapter() {

			console.info(ChapterCount + ',开始RSA解密,没有硬件支持，very slow，速度会很慢。');
			//var t1 = "{\"No\":\"1\",\"Title\":\"初见\",\"Time\":\"2021年3月4日09点41分\",\"Text\":\"内容1\",\"Readers\":[{\"Name\":\"value11\",\"Time\":\"value11\",\"Reply\":\"value11\"},{\"Name\":\"value12\",\"Time\":\"value12\",\"Reply\":\"value12\"},{\"Name\":\"value13\",\"Time\":\"value13\",\"Reply\":\"value13\"}]}";
			//mochajoebook.Chapters[ChapterCount] = JSON.parse(t1);

			if (ChapterCount < mochajoebook.EChapters.length) {

				var etext = mochajoebook.EChapters[ChapterCount].Etext;
				var ekeyiv = mochajoebook.EChapters[ChapterCount].Ekey;
				var esign = mochajoebook.EChapters[ChapterCount].Esign;

				var decrypt = new JSEncrypt();


				decrypt.setPrivateKey(privkey.value);

				var keyiv = decrypt.decrypt(ekeyiv);
				if (keyiv == null || keyiv == false) {
					alert('Rsa解密Something went wrong....');
				}
				var arr = keyiv.split(',');
				var key = CryptoJS.enc.Base64.parse(arr[0]);
				var iv = CryptoJS.enc.Base64.parse(arr[1]);
				if (key == null || iv == null) {
					alert('key iv error....');
				} else {

				}

				var text = CryptoJS.AES.decrypt(etext, key, {
					iv: iv,
					mode: CryptoJS.mode.CBC,
					padding: CryptoJS.pad.Pkcs7
				});
				text = text.toString(CryptoJS.enc.Utf8);


				var sign = CryptoJS.AES.decrypt(esign, key, {
					iv: iv,
					mode: CryptoJS.mode.CBC,
					padding: CryptoJS.pad.Pkcs7
				});
				sign = sign.toString(CryptoJS.enc.Utf8);


				var verify = new JSEncrypt();
				verify.setPublicKey(signkey.value);
				var verified = verify.verify(text, sign, CryptoJS.SHA512);

				if (verified) {
					mochajoebook.Chapters[ChapterCount] = JSON.parse(text);
					console.info(mochajoebook.Chapters[ChapterCount]);
				} else {
					alert('Something went wrong....');
				}
			}
		}
		function GetBook() {
			mochajoebook = "";
			mochajoebook = document.getElementById("ebook").value;
			mochajoebook = JSON.parse(mochajoebook);
			mochajoebook.Chapters = new Array(mochajoebook.EChapters.length);
			privkey = document.getElementById("privkey").value;
			signkey = document.getElementById("signpubkey").value;
			if (privkey.length < 100) return;

		}
		function getDocumentTop() {
			var scrollTop = 0,
				bodyScrollTop = 0,
				documentScrollTop = 0;
			if (document.body) {
				bodyScrollTop = document.body.scrollTop;
			}
			if (document.documentElement) {
				documentScrollTop = document.documentElement.scrollTop;
			}
			scrollTop = (bodyScrollTop - documentScrollTop > 0) ? bodyScrollTop : documentScrollTop;
			return scrollTop;
		}
		function getWindowHeight() {
			var windowHeight = 0;
			if (document.compatMode == "CSS1Compat") {
				windowHeight = document.documentElement.clientHeight;
			} else {
				windowHeight = document.body.clientHeight;
			}
			return windowHeight;
		}

		function getScrollHeight() {
			var scrollHeight = 0,
				bodyScrollHeight = 0,
				documentScrollHeight = 0;
			if (document.body) {
				bodyScrollHeight = document.body.scrollHeight;
			}
			if (document.documentElement) {
				documentScrollHeight = document.documentElement.scrollHeight;
			}
			scrollHeight = (bodyScrollHeight - documentScrollHeight > 0) ? bodyScrollHeight : documentScrollHeight;
			return scrollHeight;
		}
		//js 获取当前时间
		function fnDate() {
			var oDiv = document.getElementById("time");
			var date = new Date();
			var year = date.getFullYear(); //当前年份
			var month = date.getMonth(); //当前月份
			var data = date.getDate(); //天
			var hours = date.getHours(); //小时
			var minute = date.getMinutes(); //分
			var second = date.getSeconds(); //秒
			var time = year + "-" + fnW((month + 1)) + "-" + fnW(data) + " " + fnW(hours) + ":" + fnW(minute) + ":" + fnW(second);
			return time;
		}
		function fnW(str) {
			var num;
			str >= 10 ? num = str : num = "0" + str;
			return num;
		}
		function showload(event) {
			var load = document.getElementById("loading");
			load.style.visibility = "visible";
			setTimeout(addData, 50,event);
		}

		function addData(event) {
			if (!keyok) return;

			var screenHeight = getWindowHeight();
			var Chapter = document.getElementById("Chapter");
			var readerCount = 0;

			var textHeight = document.getElementById("DivChapters").offsetHeight;
			do {
				if (ChapterCount < mochajoebook.Chapters.length) {
					getChapter();

					var div = document.createElement("div");
					var txt = document.createElement("p");
					txt.className = 'Author';
					txt.innerHTML =textHeight+","+ screenHeight+","+mochajoebook.Chapters[ChapterCount].Time + "</br>" + mochajoebook.Chapters[ChapterCount].Text;
					div.align = "right";
					div.appendChild(txt);

					div.appendChild(document.createElement("p"));
					Chapter.appendChild(div);

					for (var i = 0; i < mochajoebook.Chapters[ChapterCount].Readers.length; i++) {
						textHeight = document.getElementById("DivChapters").offsetHeight;
						screenHeight = getWindowHeight();
						var div = document.createElement("div");
						var txt = document.createElement("p");
						txt.className = 'read';
						txt.innerHTML =textHeight+","+ screenHeight+","+ mochajoebook.Chapters[ChapterCount].Readers[i].Name + ":" + mochajoebook.Chapters[ChapterCount].Readers[i].Reply + "</br>" + mochajoebook.Chapters[ChapterCount].Readers[i].Time;
						div.align = "left";
						div.appendChild(txt);

						div.appendChild(document.createElement("p"));
						Chapter.appendChild(div);

					}
				}
				else {
					var div = document.createElement("div");
					var txt = document.createElement("p");
					txt.className = 'Author';
					txt.innerHTML = "没有内容了。" + "</br>" + "没有内容了。";
					div.align = "left";
					div.appendChild(txt);

					div.appendChild(document.createElement("p"));
					Chapter.appendChild(div);
				}

				ChapterCount++;
				textHeight = document.getElementById("DivChapters").offsetHeight;

			} while (textHeight < screenHeight)

			var load = document.getElementById("loading");
			load.style.visibility = "hidden";

		}
		window.onload = function () {


			pubprikey();
			GetBook();
			var head = document.getElementById("Chaptershead");

			head.innerHTML = "<p align ='center' >" + mochajoebook.Title + "</p>" + "<p align ='right' >" + mochajoebook.AuthorName + "</p>";
			head.style.align = "center";

			document.title = mochajoebook.AuthorName + "---" + mochajoebook.Title;

			document.body.scrollIntoView();
		}
		window.onscroll = function () {
			if (getScrollHeight() <= getWindowHeight() + getDocumentTop()) {
				showload();
			}
		}

		window.onclick = function (event) {
		if (getScrollHeight() <= getWindowHeight() + getDocumentTop()) {
				pubprikey();
			showload(event);
			}
			
		}

	</script>
	<style>
		textarea.pubprikey {
			width: 100%;
			height: 100%;
			border: thin double #990066;
			text-align: left;
		}

		p.Chapters {
			color: #FFECBF;
			background-color: #FFB200;
			display: block;
			visibility: visible;
			cursor: pointer;
			margin: 0 auto;
			border: 2px solid #FFB200;
			font-size: 2em;
			text-align: center;
		}

		p.Author {
			color: #FFB200;
			background-color: #FFECBF;
			display: block;
			visibility: visible;
			cursor: pointer;
			margin: 0 auto;
			border: 10px solid #FFECBF;
			border-radius: 30px;
			font-size: 2em;
			text-align: left;
		}

		p.read {
			color: #d8a373;
			background-color: #CCCCFF;
			display: block;
			visibility: visible;
			cursor: pointer;
			border: 10px solid #CCCCFF;
			border-radius: 30px;
			font-size: 2em;
			text-align: left;
		}

		div.show {
			color: #ff9955;
			text-align: right;
			float: right;
			height: 10px;
		}

		div.loading {
			color: #f3a25f;
			background-color: #FFECBF;
			display: block;
			visibility: hidden;
			cursor: pointer;
			margin: 0 auto;
			border: 10px solid #FFECBF;
			border-radius: 20px;
			font-size: 1em;
			text-align: left;

		}
	</style>
	<title>
	</title>
</head>

<body>
	<div class="show" id="show">
		<p>☆</p>
	</div>
	<div>
		<textarea class="pubprikey" onblur="pubprikey()" id="privkey" rows="15" cols="65">
-----BEGIN PRIVATE KEY-----

-----END PRIVATE KEY-----

		</textarea>

		<textarea class="pubprikey" onblur="pubprikey()" id="signpubkey" rows="15" cols="65">
-----BEGIN PUBLIC KEY-----
-----END PUBLIC KEY-----
		</textarea>

		<textarea id="ebook"
			style="display:none;">{"AuthorName":"三语沫","AuthorPubKey":"pubkey","Title":"[右岸文字]暗恋直女学妹的日子","Introduction":"value","ChaptersNumber":"value","EChapters":[{"Number":"1","Etext":"rtAYCrsEFW4lWwrSHR5y/rhv08riuc4jxKCKxz/vNDmBO7dVSrTpdDtCSJqM6n/7pU1B+4/US38c30IZGf0SyQ/Bk0v8/XQiZtYuVP2/jZxd/K3Vcz2EuZjq5FGlGZdDOZhCmMHzTl9Q6KUu2VTn1jiBmqmNE7AXC4nflcavXSn39HOq59RfH6KfzOWwXnQnAjEIbOwTfTSz/rsgoDIV/GCMvWQF9JA8DwbzPga036kCxx8+AA5q5HStl/qnFz6CmzxO9hoOsrtqHOPB3uIm9WrOsG+bvIMVdQ978I4Qm/vDw4QXcs1Q7b5O7C32fbcHkGTjR2yl2yd2AGHO644F4g==","Ekey":"JBTfa+Bjre2QRE+4dJFEIdO3pQ8lyJKeu2IIWGI3/o+tP3EDyWIG5oFGVEZ/Tt8AeQnU89AsVTa3J5aQocCDD4K4E7/UCt1bfKf5j4suG9j2piQ9gggzX9JTpBOTA+wq6Q1oEbX8SqJXl0XYoVb/HG4heng7DE9CKGkCnGfDjerMv/qCsxzw7ffiZQnUw32j9b9NSJTGtj5k6mhaAcBHF9zTFkhbLhGrQlGfHTUkMHUoV4IWxdqof5AGAOTNYYnV5O7n/intdcyGGtpncSd1xO9lgC/paQHp+3WQ/KrUt+RC6y454X8KMXkMBVf6LEDCX7OVtjsSdRfN3H9zfNRZDA==","Esign":"w6bjbBXjLbDayp0/TcgjZZJQjK+NlJ2ihp85aCISKvk3cJEm7vGhge3OkOBx/2yVYXHp0BEZtBSJ3dWlziINX8gO9K1Q+AuCBWUDtiUEEL/WUi97PoAOOscxzja5o1iRqk9e0OnBxZbzTTHQYCMFIgUa1XmKHpTxaWXW2ErCNQxFeKFp6O2sJUDE/HMTwBCHGsb4NQNB4xI48GBr8yvjZcE3jUj1vBeEkmLMBwFdAfCbScIDvmxfM9O9QPL+HElnMN0APgkdQo+D10VxHVCF1nSMQK8Lp2zOG3qqmRYgJYRY1TIlJTf2EcEqJsWlI8Fr3ejPOU1xo/Hc7pFgncW3MhJZjSprqK+cmLQRUt9Epm+Fi/cZjBCktbh3iw6mO/KE+awI73z3OrrJh9bKeuDlhDZI5W+dbwHbCQ3EJed7O/AFyUD0oN44vMbnQET9FQKP/bWm8PqRttISg+ddnX1lZw=="},{"Number":"2","Etext":"K14KP2JYscGhwwW5B0NhVseHT2WjCOMa3zuTVH95vSzKa2OKOxtGz2hpOQn+I4OHIskDzHeVGyERqCfCe+Ko/LlZiYaKuHa1h3sPOfa5jpDp6hfBFLlNNaNRSe/6a8IYhz2T6Wp8qEwPgQvTMSk8a1wUX9Lx5xqPrFGAixdwivvWqeAiOI7BqtCGpWJxUhlyC9USSuVhVG09OGoOp8oM6H96+vWy0rfCbGYzfnl10AvYJlZ8N2dW2BChhm3/1q1K6srjQz5f/XcWROjnqyGL1MlobfcWc+Awehzo2cKg/NPzvCO62vTkmmFLXLqEGvHNwolNWrQR6JwbUPm/kvHoYA==","Ekey":"yHtkcKVsyf3miixD7xW0th+TrTquE0fFqfZuKrbORfYMCC2UYp9FDwQUKXuS/6/Sor2r6k/++jMEW9dqROX+Rj71tO1U9z2b9iWIp17hsB/KqiCBrHZnRUPVeq/b6A/pVhum8BPrM01vPw98+BcGLDISNVm2FeMYU5UaYfhvFjqDziDAEYTpepdPo6Md/JHeafRjc0h0Q139zFus1TF6TfplzLkL2CpJdkKnA3dy9yM3xn9FOQQPIRQAciYCwbZv2N+KnCXPg1Ubv11lIrIc4t6E+krCWHDooE3tfrK8hBrOqOjETgP+I/XEQz1tmtxKEzgsnJOT/GppuS8opbi9dg==","Esign":"uacc03iMiXbshtSb7WmYFMn+fXD0zJ3WNx1FxMAn0ZCAuejkPMQQiNYwWwAAkKG6CD5X+YfrHbuIZjpxBTdxdQJI+vYnfGOQJAf7kGq08X95gMesqSaTUfvPfaWDp44qi6hS1I97lB9Gw58lXlWGbjjuoT/ECvmVHg6TDAP0sfDKjEwd+OJhEf+mbptNqP+D7VSBQlJDR0iJS3sLyNM3zXH2H5ud7bS/no5D7zi6K2KEhZWGf7mSbZWaIbQsAKEhDnVMkScwJFc5yN3XOi5Jm9ZFQAbcSNsrHzdsc0aERlpiMBZ4BBHStWzmFxuWTN6AnNGKYlp9ZVo+aL7dJueBcFrnxUyAn0rfAJLpukhbwoMiqfkeqMvTD0sDXr3Q0a+nweOz6ImV8zP5MuePvz+qAqYQ2+zQIkMTNiWCSyUcA6O+aBtpZ3/MZsO3L9L/QXWeI7VjeLdnAJ30l6acGZK77A=="},{"Number":"3","Etext":"YxzC8iOZwwsqDRSYOnsO7J5tfp28ZkAjl2r7V3dRpNxg6cPtt7Rm0zo/1eQ5M+2+/ZN/A1QHZwPUYITmIEGiJdoXhZmTXSDzE4VWrpaw2N8H89sM3PBTjiN6R8cyGfcC+84gx9wykSnWkVVkHwrfjUcafkDLrZcaYJ8RO2d/OlVJ9qSOiaJHsx8dVF97TM6E3LEfneoRaEjtofJTyIjXWtz+/QxR6iBy/GTrgx65/u5+MGZmpIyGtECpUPOzOF90Dke73/6lH3fM5LlKsDeyjMWm/jWcwGMbrJ7MPg2DKcZHNKeAB3qYEh1h9hKZgXxKBI2aTu6NX8TXWfx1qTcKEA==","Ekey":"a6uZjwnRocYvgb16q3dhOMA2A0zSZI5veXGQnVDD6pPRSbdMf00U1QnhaRk8zqhhli+x2qTG1BP4jpDPDPoab87Bbu/UQYcueuK5gxNAk/LZu1FIivTWVtkuQGxapj2xYzRpshemGjUyxiPvbj2A/eUM3Lncb42nVM0ViWVWoNn4BchR4dl4NW3wRY9xuDl6Lq//jb1TtYDLq7eD1NISA54rd8gmQwl6YdEdsmAIg865GXuCIv1XRB/5cEUyr1RfufzLL/fKz8qVW3UtUH7YmQWxZKLRjCAnOhKECTH/g9yYFENacwJxEn55XfyUWfcPgoVszVlwe0M+EdhCVBi79w==","Esign":"W1utVOG99T4nV8s/fq/eBeN86MEYdxFxMpYctIR1NDPXGND5dlVxk4tPBqxm0RE+crrlwpYCL82vDBgIiDYgynxqFGrV1GsJJ5mVpm+xskHFDTymiGwUAdn5n5VG3FamK4fTDJLngWLp5SHee88p6RolR8XN3TGLzYsDFDN8GXXZ7YAIHx/9MWdqB2OVhBYS8noSIFzHUvLtKwge4RFXFaS79vfXIgAuaCfmgWgEepwzMZeLY3dp0eXzYzTiUDbL4Tdlq9myZGHXK+BzF57FgqrLRm4ASVnS4FZHcS+42Uwl/sm4YfWuhVNxGnLxO7oBIDMVj5AxK06pJLbvY2L0j5PSyFanLWrfeUwKY9PtUPlNniB1Jt2ft3b1Amw4/80K188Yt36JBdaMzDM8PtrH4oKAXadieqWDRXLpDcQKPgOXE+hxRDjsVFXiv397R+rBKN2zURGaZpgwbzRnacWv5Q=="}],"ProducerName":"mochajoe","ProductionSoftware":"OuatTianYaHtmlMaker v1.0","OwnerName":"fun","OwnerPriKey":"prikey","Config":"1"}</textarea>
	</div>

	<div id="DivChapters">

		<p class="Chapters" id="Chaptershead">
			<br />
		</p>
		<p></p>

		<div id="Chapter">
		</div>
		<div id="Reader">
		</div>
		<div class="loading" id="loading">
			<p>
				开始加载，硬件不支持RSA解密，没有硬件支持，速度会很慢，very slow。
			</p>
		</div>

	</div>



</body>

</html>